<!-- /snippets/account-address-form.liquid -->

<div id="{{form_outer_id}}" class="address__form relative w1 {{form_classes}}" style="display: none;">

    {% form 'customer_address', form_action %}

        {% assign form_id = form.id %}
        {% capture form_script %}{% if form_id == 'new' %}barrel.toggleNewForm(event){% else %}barrel.toggleForm(event, {{form_id}}){% endif %}{% endcapture %}
        {% capture form_suffix %}{% if form_id and form_id != 'new' %}_{{form_id}}{% endif %}{% endcapture %}

        {% capture form_city_id %}{% if form_id == 'new' %}AddressCityNew{% else %}AddressCity{% endif %}{% endcapture%}
        {% capture form_country_id %}{% if form_id == 'new' %}AddressCountryNew{% else %}AddressCountry{% endif %}{% endcapture%}
        {% capture form_province_container_id %}{% if form_id == 'new' %}AddressProvinceContainerNew{% else %}AddressProvinceContainer{% endif %}{% endcapture%}
        {% capture form_province_id %}{% if form_id == 'new' %}AddressProvinceNew{% else %}AddressProvince{% endif %}{% endcapture%}

        <h4>{{form_title}}</h4>

        <div class="address__form__group flex flex-wrap flex-justify">
            {% assign address_field_id = 'AddressFirstNameNew' | append: form_suffix %}
            {% include 'input-text', label: 'First Name', name: 'address[first_name]', value: form.first_name, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}

            {% assign address_field_id = 'AddressLastNameNew' | append: form_suffix %}
            {% include 'input-text', label: 'Last Name', name: 'address[last_name]', value: form.last_name, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}
        </div>

        <div class="address__form__group flex flex-wrap flex-justify">
            {% assign address_field_id = 'AddressCompanyNew' | append: form_suffix %}
            {% include 'input-text', label: 'Company', name: 'address[company]', value: form.company, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}

            {% assign address_field_id = 'AddressPhoneNew' | append: form_suffix %}
            {% include 'input-text', label: 'Phone', name: 'address[phone]', type: 'tel', value: form.phone, id: address_field_id, class: 'address__form__field' %}
        </div>

        <div class="address__form__group flex flex-wrap flex-justify">
            {% assign address_field_id = 'AddressAddress1New' | append: form_suffix %}
            {% include 'input-text', label: 'Address1', name: 'address[address1]', value: form.address1, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}
            
            {% assign address_field_id = 'AddressAddress2New' | append: form_suffix %}
            {% include 'input-text', label: 'Address2', name: 'address[address2]', value: form.address2, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}
        </div>

        <div class="address__form__group flex flex-wrap flex-justify">
            {% assign address_field_id = form_city_id | append: form_suffix %}
            {% include 'input-text', label: 'City', name: 'address[city]', value: form.city, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}

            <div class="address__form__field input-group">
                <label for="{{form_country_id}}{{form_suffix}}" class="block">Country:</label>
                <span class="select-wrapper w1">
                    <select id="{{form_country_id}}{{form_suffix}}" class="block w1" name="address[country]" data-default="{{ form.country }}">{{ country_option_tags }}</select>
                </span>
            </div>
        </div>

        <div class="address__form__group flex flex-wrap flex-justify">
            <div class="address__form__field input-group">
                <span id="{{form_province_container_id}}{{form_suffix}}" style="display:none">
                    <label for="{{form_province_id}}{{form_suffix}}" class="block">Province:</label>
                    <span class="select-wrapper w1">
                        <select id="{{form_province_id}}{{form_suffix}}" class="w1" name="address[province]" data-default="{{ form.province }}"></select>
                    </span>
                </span>
            </div>

            {% assign address_field_id = 'AddressZipNew' | append: form_suffix %}
            {% include 'input-text', label: 'Zip', name: 'address[zip]', value: form.zip, autocapitalize: 'words', id: address_field_id, class: 'address__form__field' %}
        </div>

        <div class="input-group">
            <label for="address_default_address_new{{form_suffix}}" class="checkbox mr05">
                {{ form.set_as_default_checkbox }}
                Set as default address
            </label>
        </div>

        <p class="pt1">
            <button type="submit" class="button">{{form_cta}}</button> 
            <a href="#0" class="ml1 underline" onclick="{{form_script}}">Cancel</a>
        </p>

    {% endform %}

</div>

{% assign form_id = false %}
{% assign form_classes = '' %}

<script>
(function(){
    var form = document.getElementById({{form_outer_id | json}})
    var countrySelector = document.getElementById({{form_country_id | json}}+{{form_suffix | json}})
    var provinceContainer = document.getElementById({{form_province_container_id | json}}+{{form_suffix | json}})
    var provinceSelector = document.getElementById({{form_province_id | json}}+{{form_suffix | json}})
    var countryDefault = countrySelector.getAttribute('data-default') ? countrySelector.getAttribute('data-default') : countrySelector.options[0].value
    var provinceDefault = provinceSelector.getAttribute('data-default')

    /**
     * Select an option within a <select>
     * based on a given value
     *
     * @param {string} value Value to search for
     * @param {element} select <select> element
     * @return {element} The first matching select option
     */
    function selectOption(value, select){
        return Array.prototype.slice.call(select.options).filter(function(option, i){
            if (option.value === value){
                select.selectedIndex = i
                return true
            }
            return false
        })[0]
    }

    /**
     * Generate province options and show select element
     *
     * @param {array} options Array of arrays from selected country
     */ 
    function showProvinces(options){
        var previousValue = provinceSelector.options[0] ? provinceSelector.options[0].value : false 
        var isNewValue = !previousValue || options[0][0] !== previousValue ? true : false

        if (isNewValue){
            // Emptry provinces select
            provinceSelector.innerHTML = ''

            // Generate new options from values
            for (var i = 0; i < options.length; i++){
                var option = document.createElement('option')
                option.value = options[i][0]
                option.innerHTML = options[i][1]
                provinceSelector.appendChild(option) 
            }
        }

        // Select the default province
        if (provinceDefault.length > 0) selectOption(provinceDefault, provinceSelector)

        // Show provinces
        provinceContainer.style.display = 'block'
    }

    /**
     * Hide provinces container
     */
    function hideProvinces(){
        provinceContainer.style.display = 'none'
    }

    /**
     * If we have an active default country,
     * select it and select it's default province
     *
     * (this is for the edit form)
     */
    function selectDefaults(){
        if (countryDefault.length < 1) return

        var selectedCountry = selectOption(countryDefault, countrySelector)
        var options = JSON.parse(selectedCountry.getAttribute('data-provinces'))

        showProvinces(options)
    }

    /**
     * Setup onchange listener for countries
     */
    countrySelector.onchange = function(e){
        var selectedOption = countrySelector.options[countrySelector.selectedIndex]
        var options = JSON.parse(selectedOption.getAttribute('data-provinces')) || []

        options.length > 0 ? showProvinces(options) : hideProvinces()
    }

    selectDefaults()
})()
</script>
